<!DOCTYPE html>
<html>
<head>
	<title>首页</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<#include "/common.shtml" />
	<link rel="stylesheet" href="${rc.contextPath}/css/compiled/tables.css" type="text/css" media="screen" />
</head>
<body>
	
	<!-- navbar -->
    <#include "/common_nav_header.shtml" />
    <!-- end navbar -->

	<!-- sidebar -->
	<#include "/common_nav_left.shtml" />
    <!-- end sidebar -->

	<div class="content">
		<div class="container-fluid">
           <div id="pad-wrapper" class="table-wrapper users-list">
           		首页
			</div>
		</div>
	</div>
	<!-- end main container -->
	<link rel="stylesheet" href="${rc.contextPath}/js/layui/css/layui.css" type="text/css" media="screen" />
	<script type="text/javascript" src="${rc.contextPath}/js/layui/layui.js"></script>
	<script type="text/javascript">
	var socket;
	
	layui.use('layim', function(layim){
		if (window.WebSocket) {
			socket = new WebSocket('ws://localhost:8888');
			socket.onmessage = function(event) {
				var re = JSON.parse(event.data);
				if(re.status == 1){
					var data = re.data;
					// 连接成功
					if(data.resultCode == 1){
						layer.msg("连接服务器成功",{icon:1});
					}
					// 接收到好友信息
					else if(data.resultCode == 2){
						console.info(data.msg);
						layim.getMessage(data.msg);
					}
				}else{
					layer.msg(re.message,{icon:2});
				}
			};
			socket.onopen = function(event) {
				var mine = new Mine(null,null,${mid!''},true,null);
				var to = new To(null,0,null,null,null,null);
				var msg = new Msg(mine,to,'bind',0);
				socket.send(JSON.stringify(msg));
			};
			socket.onclose = function(event) {
				layer.msg("连接关闭",{icon:1});
			};
			layim.config({
				brief: false,
				copyright: true,
				title: '聊天室',
				//初始化接口
			    init: {
					url: '${rc.contextPath}/im/init.htm',
					data: {}
			    },
			    //查看群员接口
			    members: {
			    }
			});
			layim.on('sendMessage', function(res){
				res.type = res.to.type;
				var msg = JSON.stringify(res);
				socket.send(msg);
			});
		}else{
			layer.msg("浏览器对不起浏览器不支持在线聊天系统！",{icon:2});
		}
	});
	
	function Msg(mine,to,type,resultCode){ 
		this.mine = mine;
		this.to = to;
		this.type = type;
		this.resultCode = resultCode;
	}
	function Mine(avatar,content,id,mine,username){ 
		this.avatar = avatar;
		this.content = content;
		this.id = id;
		this.mine = mine;
		this.username = username;
	}
	function To(avatar,id,name,sign,type,username){ 
		this.avatar = avatar;
		this.id = id;
		this.name = name;
		this.sign = sign;
		this.type = type;
		this.username = username;
	}
	</script>
</body>
</html>